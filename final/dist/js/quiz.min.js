const questionsFR = [
    {
        question: "Pensez-vous avoir ou avoir eu de la fièvre ces 10 derniers jours (frissons, sueurs) ?",
        type: "radio",
        answers: ["oui", "non"]
    },
    {
        question: "Quelle est votre température corporelle ?",
        type: "number",
        label: "degés"
    },
    {
        question: "Ces derniers jours, avez-vous une toux ou une augmentation de votre toux habituelle ?",
        type: "radio",
        answers: ["oui", "non"]
    },
    {
        question: "Avez-vous eu des courbatures inhabituelles au cours des derniers jours ?",
        type: "radio",
        answers: ["oui", "non"]
    },
    {
        question: "Ces derniers jours, avez-vous un mal de gorge ?",
        type: "radio",
        answers: ["oui", "non"]
    },
    {
        question: "Ces dernières 24 heures, avez-vous de la diarrhée ? Avec au moins 3 selles mol les.",
        type: 'radio',
        answers: ['Oui', 'Non']

    }, {
        question: 'Ces derniers jours, avez-vous une fatigue inhabituelle qui vous a obligé à vous reposer plus de la moitié de la journée ?',
        type: 'radio',
        answers: ["oui", "non"]

    },
    {
        question: 'Avez-vous des difficultés importantes pour vous alimenter ou boire depuis plus de 24h ?',
        type: 'radio',
        answers: ["oui", "non"]
    },
    {
        question: 'Dans les dernières 24 heures, avez-vous noté un manque de souffle inhabituel lorsque vous parlez ou faites un petit effort ?',
        type: 'radio',
        answers: ["oui", "non"]

    },
    {
        question: 'Actuellement, comment vous vous sentez ?',
        type: 'radio',
        answers: ['Bien', 'Assez bien', 'Fatigué(e)', 'Très fatigué']

    },
    {
        question: 'Quel est votre âge ? Ceci, afin de calculer un facteur de risque spécifique.',
        type: 'number',
        label: 'ans',
    },
    {
        question: 'Quel est votre poids ? Afin de calculer l’indice de masse corporelle qui est un facteur influençant le risque de complications de l’infection.',
        type: 'number',
        label: 'kg',
    },
    {
        question: 'Quelle est votre taille ? Afin de calculer l’indice de masse corporelle qui est un facteur influençant le risque de complications de l’infection.',
        type: 'number',
        label: 'cm'

    },
    {
        question: 'Avez-vous de l’hypertension artérielle mal équilibrée ? Ou avez-vous une maladie cardiaque ou vasculaire ? Ou prenez-vous un traitement à visée cardiologique ?',
        type: 'radio',
        answers: ["oui", "non"]

    },
    {
        question: 'Êtes-vous diabétique ?',
        type: 'radio',
        answers: ["oui", "non"]

    },
    {
        question: 'Avez-vous ou avez-vous eu un cancer ?',
        type: 'radio',
        answers: ["oui", "non"]
    },
    {
        question: 'Avez-vous une maladie respiratoire ? Ou êtes-vous suivi par un pneumologue ?',
        type: 'radio',
        answers: ["oui", "non"]

    }, 
    {
        question: 'Avez-vous une insuffisance rénale chronique dialysée ?',
        type: 'radio',
        answers: ["oui", "non"]
    }, 
    {
        question: 'Avez-vous une maladie chronique du foie ?',
        type: 'radio',
        answers: ["oui", "non"]
    }, 
    {
        question: 'Êtes-vous enceinte ?',
        type: 'radio',
        answers: ["oui", "non", "homme"]
    }, 
    {
        question: 'Avez-vous une maladie connue pour diminuer vos défenses immunitaires ?',
        type: 'radio',
        answers: ["oui", "non"]
        
    }, 
    {
        question: 'Prenez-vous un traitement immunosuppresseur ? C’est un traitement qui diminue vos défenses contre les infections. Voici quelques exemples: corticoïdes, méthotrexate, ciclosporine, tacrolimus, azathioprine, cyclophosphamide (liste nonexhaustive).',
        type: 'radio',
        answers: ["oui", "non"]
    }
];

const adviceFR = {
    num1 : "nous vous conseillons de rester à votre domicile et de contacter votre médecin en cas d’apparition de nouveaux symptômes. Vous pourrez aussi utiliser à nouveau l’application pour réévaluer vos symptômes.",
    num2 : "téléconsultation ou médecin généraliste ou visite à domicile.",
    num3 : "Votre situation ne relève probablement pas du Covid-19. Consultez votre médecin au moindre doute.",
    num4 : "Votre situation ne relève probablement pas du Covid-19. Un avis médical est recommandé. Au moindre doute, appelez le 141.",
    num5 : "Votre situation ne relève probablement pas du Covid-19. N’hésitez pas à contacter votre médecin en cas de doute. Vous pouvez refaire le test en cas de nouveau symptôme pour réévaluer la   situation.   Pour   toute information concernant   le   Covid-19 allez vers la page d’accueil.",
    disclamer: "La recommandation affichée peut évoluer suivant les informations en provenance des autorités de santé et des chercheurs. Elle ne constitue pas un avis médical. En cas de doute, demandez conseil à votre médecin ou pharmacien."
}
const questionsAR = [
    {
        question: "واش كانت فيك السخانة في 10 أيام لي فاتت (التوريشة,العرق)؟",
        type: "radio",
        answers: ["نعم", "لا"]
    },
    {
        question: "شحال درجة الحرارة ديالك ؟",
        type: "number",
        label: 'درجة'
    },
    {
        question: "في الايام لي فاتو واش كانت فيك الكحبة اولا تزادت الكحبة لي كانت كتجيك عادية؟",
        type: "radio",
        answers: ["نعم", "لا"]
    },
    {
        question: 'واش كتعاني من آلام عضلية غير معتادة في الأيام القليلة لي فاتت؟',
        type: "radio",
        answers: ["نعم", "لا"]
    },
    {
        question: 'واش كتحس بآلام فحلقك هاد الايام ؟',
        type: "radio",
        answers: ["نعم", "لا"]
    },
    {
        question: 'فهاد 24 ساعة لي فاتو واش كان فيك الإسهال ؟ على الاقل 3 مرات',
        type: 'radio',
        answers: ['نعم', 'لا']

    }, {
        question: 'فهاد الايام لي فاتو، واش عيتي بطريقة ماشي عادية لدرجة بقيتي مريح اكثر من نص يوم ؟',
        type: 'radio',
        answers: ["نعم", "لا"]

    },
    {
        question: 'واش لقيتي صعوبة كبيرة فالماكلة و الشراب لاكثر من 24 ساعة ؟',
        type: 'radio',
        answers: ["نعم", "لا"]
    },
    {
        question: 'واش كتحس بضيق فالتنفس ملي كتكلم ولا كدير جهد كثر من العادة ؟',
        type: 'radio',
        answers: ["نعم", "لا"]

    },
    {
        question: 'فهاد الوقت كيف كتحس بالجسم ديالك ؟',
        type: 'radio',
        answers: ['مزيان','شويا', 'عيان', 'مهلوك']

    },
    {
        question: 'شحال عندك فعمرك ؟ هادشي باش نقدو نعرفو الخطورة ديال المرض إلا كان.',
        type: 'number',
        label: 'ans',
    },
    {
        question: 'شحال عندك فالوزن ؟ باش نعرفو مؤشر الوزن ديال الجسم ديالك حيث يقدر يتزاد عليك الحال فحالة كان فيك الڤيروس',
        type: 'number',
        label: 'kg',
    },
    {
        question: 'شحال فيك فالطول ؟ باش نعرفو مؤشر الوزن ديال الجسم ديالك حيث يقدر يتزاد عليك الحال فحالة كان فيك الڤيروس',
        type: 'number',
        label: 'cm'

    },
    {
        question: 'واش عندك ارتفاع ضغط الدم ؟ ولا فيك مرض القلب او الأوعية الدموية ؟ او كتاخد دوا ديال القلب ؟',
        type: 'radio',
        answers: ["نعم", "لا"]

    },
    {
        question: 'فيك مرض السكر ؟',
        type: 'radio',
        answers: ["نعم", "لا"]

    },
    {
        question: 'واش فيك السرطان ولا كان فيك السرطان؟',
        type: 'radio',
        answers: ["نعم", "لا"]
    },
    {
        question: 'واش عندك الضيقة ؟ او متبع مع شي طبيب ديال الرية',
        type: 'radio',
        answers: ["نعم", "لا"]

    },
    {
        question: 'واش كدير دياليز؟',
        type: 'radio',
        answers: ["نعم", "لا"]
    },
    {
        question: 'واش عندك إلتهاب فالكبد ؟',
        type: 'radio',
        answers: ["نعم", "لا"]
    },
    {
        question: 'واش حاملة ؟',
        type: 'radio',
        answers: ["نعم", "لا", "راجل"]
    },
    {
        question: 'واش عندك شي مرض تينقص لك المناعة ديالك ؟',
        type: 'radio',
        answers: ["نعم", "لا"]

    },
    {
        question: 'واش تتاخد شي دواء تينقص لك المناعة ديالك ؟ بحال: الكورتيكوستيرويدات ، الميثوتريكسات ، السيكلوسبورين ، تاكروليموس ، الآزوثيوبرين ، سيكلوفوسفاميد (كاين ادوية اخرى من غير هادو).',
        type: 'radio',
        answers: ["نعم", "لا"]
    }
];

const adviceAR = {
    num1 : "نوصي بالبقاء في المنزل والاتصال بطبيبك إذا ظهرت أعراض جديدة. يمكنك أيضًا استخدام التطبيق مرة أخرى لإعادة تقييم أعراضك.",
    num2 : "استشارة عن بعد أو ممارس عام أو زيارة منزلية.",
    additinalAdv: "بالنسبة لأي مريض يحال إلى استشارة طبية أو ممارس عام: حدد اتصل برقم 141 إذا ظهرت صعوبات في التنفس أو صعوبة كبيرة في تناول الطعام أو الشرب لأكثر من 24 ساعة.”",
    num4 : "حالتك الصحية متتخلعش",
    num5 : "حالتك الصحية متتخلعش إذا كنت في شك ، اتصل بـ 141.",
    num6 : "ربما لا يندرج وضعك تحت Covid-19. لا تتردد في الاتصال بطبيبك إذا كنت في شك. يمكنك تكرار الاختبار إذا كان هناك عرض جديد لإعادة تقييم الموقف. للحصول على جميع المعلومات المتعلقة بـ Covid-19 ، انتقل إلى الصفحة الرئيسية.",
    stayhome: "بقى فدارك، وحاول متخالطش مع الناس، بزاف ديال الناس الي فيهم الفيروس ماتايبانش فيهم أعراض المرض",
    disclamer: "قد تتغير التوصية المعروضة وفقًا لمعلومات من السلطات الصحية والباحثين. لا تشكل نصيحة طبية. إذا كنت في شك ، اطلب من طبيبك أو الصيدلي النصيحة."
};
// ************************************************

// Models

// ************************************************

let Models = (() => {
    let advice, data;
    data = {
        answers : [],
        gravityFa: {
            gravity:0,
            minor:0,
            major:0
        },
        pronostique: 0,
        age: 0,
        temp:0
    }
    let symptoms = {
        fever: false,
        toux: false,
        courbatures: false,
        gorge: false,
        diarrhee: false
    }

    //Advice variable
    if (localStorage.getItem("lang")) {
        localStorage.getItem("lang") === "fr" ? advice = adviceFR : advice = adviceAR;
        
    } else {
        advice = adviceFR;
    }

    //helper functions
    let addMinGravity = () =>{
        data.gravityFa.gravity += 1 
        data.gravityFa.minor += 1
    }
    let addMajorGravity = () =>{
        data.gravityFa.gravity += 1 
        data.gravityFa.major += 1
    }
    return {
        storeData: (id, type, input) => {
            let inputDATA = {id: id, type: type, answer: input}
            if(data.answers[id]){
                data.answers[id] = inputDATA;
                return
            }
            data.answers.push(inputDATA)
        },

        processData: () => {
            // processing symptoms
            if(data.answers[0].answer === "oui")
            symptoms.fever = true
            addMinGravity()
            if(data.answers[2].answer === "oui")
            symptoms.toux = true
            if(data.answers[3].answer === "oui")
            symptoms.courbatures = true
            if(data.answers[4].answer === "oui")
            symptoms.gorge = true
            if(data.answers[5].answer === "oui")
            symptoms.diarrhee = true
            //age
            data.age += parseFloat(data.answers[10].answer)
            // processing gravity factors
            if(parseFloat(data.answers[1].answer) > 39 || parseFloat(data.answers[1].answer) < 35.4 )
            addMinGravity()
            data.temp += parseFloat(data.answers[1].answer) 
            if(data.answers[6].answer === "oui")
            addMinGravity()
            if(data.answers[7].answer === "oui")
            addMajorGravity()
            if(data.answers[8].answer === "oui")
            addMajorGravity()
            if(data.answers[9].answer === "Fatigué(e)" || data.answers[9].answer === "Très fatigué" )
            addMinGravity()

            //Processing prognosis factor
            let prognosis = data.answers.slice(13, 22)
            prognosis.forEach(el => {
                el.answer === "oui" ? data.pronostique += 1 : "";
            });
        },

        CalculateResults: () => {
            if(symptoms.fever || symptoms.toux && symptoms.gorge || symptoms.toux && symptoms.courbatures || symptoms.fever && symptoms.diarrhee){
                if(data.pronostique === 0){
                    if(data.gravityFa.gravity === 0 && data.age < 50)
                    return advice.num2
                    if(data.gravityFa.gravity === 0 && 50 < data.age < 69 || data.gravityFa.minor >= 1)
                    return advice.num2
                }
                else {
                    if(data.gravityFa.gravity === 0 )
                    return advice.num2
                    if(data.gravityFa.minor == 2)
                    return advice.stayhome
                }

            }
            if(symptoms.fever && symptoms.toux ) {
                if(data.pronostique === 0 && data.gravityFa.minor == 0)
                return advice.num2
                if(data.pronostique > 0 && data.gravityFa.minor >= 0 || data.gravityFa.gravity === 0)
                return advice.num2


            }
            if(symptoms.fever || symptoms.toux || symptoms.gorge ||  symptoms.courbatures) {
                if(data.gravityFa.gravity == 0)
                return advice.num4
                if(data.pronostique >= 1 && data.gravityFa.gravity >= 1)
                return advice.num3
                
            }
            
            return advice.num5
            
        },
        Data: () => {
            console.log(data);
        },

        symptom: () => {
            console.log(symptoms);
            
        },

        advice: () => {
            return advice;
        }
    }
})();



// ************************************************

// UI controller

// ************************************************

let UIcontroller = (() => {
    let DOMstrings, questions;
    DOMstrings = {
        intro: '.quiz-initiation ',
        quizNav: '.quiz-nav',
        btnInit: '.btn-init',
        btnNext: '.btn-next',
        btnPrev: '.btn-prev',
        btnRepete: '.btn-repete',
        QuizQuestion: '.quiz__question',
        QuizBody: '.quiz-body',
        QuizAnswer: '.quiz__answers',
        dotSteps: '.bar__dot-info--init',
        progressBar: '#progress-bar',
        progressBarclasse: '.progress-bar',
        progressLabel: ".progress-bar__label",
        QuizResult: ".QuizResult",
        QuizAnsResult: ".QuizResult__title"

    };


    if (localStorage.getItem("lang")) {
        localStorage.getItem("lang") === "fr" ? questions = questionsFR : questions = questionsAR;
        
    } else {
        questions = questionsFR;
    }

    return {
        getDOMstrings: () => {
            return DOMstrings;
        },
        checkType: (id) => {
            return questions[id].type;
        },
        showQuestions: (id, type) => {
            // 1 . hide preamble and start btn (UI)
            if (id === 0) {
                document.querySelector(DOMstrings.intro).classList.add('hidden');
                document.querySelector(DOMstrings.btnInit).classList.add('hidden');
                document.querySelector(DOMstrings.btnNext).classList.remove('hidden');
                document.querySelector(DOMstrings.QuizBody).classList.remove('hidden');
                document.querySelector(DOMstrings.dotSteps).style.left = '23.5rem';
            } else {
                document.querySelector(DOMstrings.btnPrev).classList.remove('hidden');

            }
            // 2 . Clear Field 
            document.querySelector(DOMstrings.QuizAnswer).innerHTML = "";
            // 2 . show  questions (UI)
            document.querySelector(DOMstrings.QuizQuestion).textContent = questions[id].question;

            if (type === "number") {
                if(id === 1) 
                document.querySelector(DOMstrings.QuizAnswer).insertAdjacentHTML('beforeend', `<div class="quiz__answers-input "><input type="number" min="34" max="42" step="1" value="" placeholder="37,0" id="val-input" required><label for=val-input>${questions[id].label}</label></div> `)
                
                if(id === 10)
                    document.querySelector(DOMstrings.QuizAnswer).insertAdjacentHTML('beforeend', `<div class="quiz__answers-input "><input type="number" min="15" max="110" step="1" value="" placeholder="15 - 110" id="val-input" required><label for=val-input>${questions[id].label}</label></div> `)
                if(id === 11)
                    document.querySelector(DOMstrings.QuizAnswer).insertAdjacentHTML('beforeend', `<div class="quiz__answers-input "><input type="number" min="20" max="250" step="1" value="" placeholder="60" id="val-input" required><label for=val-input>${questions[id].label}</label></div> `)
                if(id === 12)
                    document.querySelector(DOMstrings.QuizAnswer).insertAdjacentHTML('beforeend', `<div class="quiz__answers-input "><input type="number" min="40" max="250" step="1" value="" placeholder="170" id="val-input" required><label for=val-input>${questions[id].label}</label></div> `)

            } else {
                questions[id].answers.forEach(element => {
                    let elname;
                    if (element === "نعم") {
                        elname = "oui";
                    } else if (element === "لا") {
                        elname = "non";
                    } else if (element === "مزيان") {
                        elname = "bien";
                    } else if (element === "شويا") {
                        elname = "Assez bien";
                    } else if (element === "عيان") {
                        elname = "Fatigué(e)";
                    } else if (element === "مهلوك") {
                        elname = "Très fatigué";
                    } else if (element === "راجل") {
                        elname = "homme";
                    } else {
                        elname = element;
                    }
                    document.querySelector(DOMstrings.QuizAnswer).insertAdjacentHTML('beforeend', `<div class="quiz__answers-option">
                    <input type="radio" id="f-option" value="${elname}" name="selector" >
                    <label for="f-option">${element}</label>
                    <div class="check"></div>
                </div>`)

                });
            }


        },

        DisplayResults: (res) => {
            document.querySelector(DOMstrings.QuizResult).classList.remove('hidden');
            document.querySelector(DOMstrings.btnRepete).classList.remove('hidden');
            document.querySelector(DOMstrings.progressBarclasse).classList.add('hidden');
            document.querySelector(DOMstrings.btnNext).classList.add('hidden');
            document.querySelector(DOMstrings.btnPrev).classList.add('hidden');
            document.querySelector(DOMstrings.QuizBody).classList.add('hidden');
            console.log(res)
            document.querySelector(DOMstrings.QuizAnsResult).textContent = `${res}`;

        },
        progressBar: (id) => {
            // if(id === 21){
            //     document.querySelector(DOMstrings.dotSteps).style.left = '44.5rem';
            //     return
            // }
            document.querySelector(DOMstrings.progressBar).value = id;
            document.querySelector(DOMstrings.progressLabel).textContent = `${id}/22`;
            
        },
        questions: () => {
            return questionsFR;
        }
    }
})();



// ************************************************

// Quiz Controller

// ************************************************

let Controller = ((Model, UIctrl) => {
    let QuestionID = 0, type, DOM, input;
    let setupEventListeners = () => {
        DOM = UIctrl.getDOMstrings();
        document.querySelector(DOM.btnInit).addEventListener('click', startQuiz);
        // document.addEventListener('keypress', (e) => {
        //     e.keyCode === 13 || e.which === 13 ? startQuiz() : "";
        // });
        document.querySelector(DOM.btnNext).addEventListener('click', displayQuestions);
        document.querySelector(DOM.btnPrev).addEventListener('click', previousQuestion);
        document.querySelector(DOM.QuizAnswer).addEventListener('change', (e) => evaluateRadio(e));
        document.querySelector(DOM.QuizAnswer).addEventListener('keyup', (e) => evaluateRadio(e));
   
    }



    let evaluateRadio = (e) => {
        if (e.target.value && e.target.checkValidity() ) {
            enabelBTN(DOM.btnNext);
            input = e.target.value
        } else {
            disabelBTN(DOM.btnNext);
            e.target.reportValidity();
        }
    }



    let startQuiz = () => {
        // 1 . show first question 
        UIctrl.showQuestions(QuestionID);
        // QuestionID++;
        // Progress bar
        UIctrl.progressBar(QuestionID + 1);
        disabelBTN(DOM.btnNext);

    };

    let displayQuestions = () => {
        //3 . Get input data
        type = UIctrl.checkType(QuestionID);
        console.log(QuestionID)
        if(input !== "" ) {
            //Add results to the data structure
            Model.storeData(QuestionID, type, input)

        } else {
            disabelBTN(DOM.btnNext);
            return
        }
        input = "";
        // proccess data at the end
        if(QuestionID === 21){
            //Process the data 
            Models.processData();

            //Calculate  results based on the algorithm
            let finalResults = Models.CalculateResults();
            console.log(finalResults);
            
        
            // Calculate and UpdateResults
            UIctrl.DisplayResults(finalResults);
            //Dot results
           document.querySelector(DOM.dotSteps).style.left = '44.5rem';
            return
        }

        // 1 . get type and increment ID variable
        QuestionID++
        type = UIctrl.checkType(QuestionID);
        console.log(QuestionID)
    

        // 2 . display Next question
        UIctrl.showQuestions(QuestionID, type);
        disabelBTN(DOM.btnNext)
    
        // Progress bar
        UIctrl.progressBar(QuestionID + 1);
        enabelBTN(DOM.btnPrev)

         

    }

    let previousQuestion = () => {
        if(QuestionID === 1){
            disabelBTN(DOM.btnPrev)
        }else if(QuestionID === 0) {
            return
        }
        else {
            enabelBTN(DOM.btnPrev)
        }
         
        QuestionID--;
        type = UIctrl.checkType(QuestionID);
        //update the question
        UIctrl.showQuestions(QuestionID, type);
        //update the progress bar
        UIctrl.progressBar(QuestionID + 1);


    }

    ///Helper functions
    const disabelBTN = selector => {
        document.querySelector(selector).disabled = true
    }
    const enabelBTN = selector => {
        document.querySelector(selector).disabled = false
    }


    return {
        init: () => {
            console.log('Quiz started !');
            setupEventListeners();
        }
    }
})(Models, UIcontroller);

// Initilation the quiz 
Controller.init();